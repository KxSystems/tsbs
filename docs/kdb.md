# TSBS Supplemental Guide: KDB

KDB is a purpose-built time-series database from KX.
This supplemental guide explains how
the data generated for TSBS is stored, additional flags available when
using the data importer (`tsbs_load_kdb`), and additional flags
available for the query runner (`tsbs_run_queries_kdb`). **This
should be read *after* the main [README](../README.md).**

## Data format

Data generated by `tsbs_generate_data` for KDB is serialized in a
"pseudo-CSV" format. Each reading is composed of a single line where
the name of the table is the first item, a comma, followed by several
comma-separated items of tags and values.

## Preconditions
To run TSBS for KDB, the following are necessary:
- kdb/q installed with a valid license
- starting the KDB server for the use-case under test (`./scripts/q_sys/start_kdb.sh --usecase <usecase>`)

## Scripts

By default, KDB does not run as a service or daemon.  It is therefore required for KDB to be started in advance of a test execution.

| Script | Description |
| ------ | ------ |
| [./scripts/q_sys/start_kdb.sh --usecase <usecase>](../scripts/q_sys/start_kdb.sh ) | Starts KDB database for the specified <usecase> "iot", "devops" or "cpu-only" usecase        |
| [./scripts/q_sys/stop_kdb.sh](../scripts/q_sys/stop_kdb.sh) | Stops KDB database      |
| [./scripts/q_sys/clear_kdb.sh](../scripts/q_sys/clear_kdb.sh)    | Clears the on-disk files of the KDB database.  This is a separate script as users may wish to run multiple `tsbs_run_queries_kdb` scenarios on the same dataset. It should always be run before `tsbs_load_kdb`  |

## Setup and example test run

The following settings can be modified as follows:

| File                                      | Setting | Description  |
| ------                                    | ------  | ------  |
| [./scripts/q_sys/env](../scripts/q_sys/env) | QEXEC   | _Optional_ - used to specify a custom kdb installation location. Otherwise this will be picked up from the $PATH |
| [./scripts/q_sys/env](../scripts/q_sys/env) | DBDIR   | _Advised_ - This directory should be put on a fast storage medium. It must be an absolute path |

NOTE: To avoid IO contention the input gz file (generated by `tsbs_generate_data`) and the **DBDIR** data storage location should reside on different disks.

### Example run (from root directory)

```
tsbs_generate_data --use-case="devops" --seed=124 --scale=100 \
    --timestamp-start="2016-01-01T00:00:00Z" \
    --timestamp-end="2016-01-02T00:00:00Z" \
    --log-interval="10s" --format="kdb" | gzip > /tmp/kdb-data.gz

tsbs_generate_queries --use-case="devops" \
    --timestamp-start="2016-01-01T00:00:00Z" \
    --timestamp-end="2016-01-02T00:00:00Z" \
    --queries=5 --query-type="single-groupby-1-1-1" --format="kdb" > /tmp/kdb-queries.csv

./scripts/q_sys/clear_kdb.sh
source ./scripts/q_sys/env
source ./scripts/q_sys/perfenv_ingest
source ./scripts/q_sys/perfenv_query
./scripts/q_sys/start_kdb.sh --usecase devops

cat /tmp/kdb-data.gz | gunzip | tsbs_load_kdb --workers 1

cat /tmp/kdb-queries.csv | tsbs_run_queries_kdb --port=5010

./scripts/q_sys/stop_kdb.sh

```

You can check the logs of the kdb+ system in directory `scripts/q_sys/log`. The kdb+ writer does the majority of the work so it is worth taking a look at `scripts/q_sys/log/writer.log`.

### Kdb+ performance fine tuning
There are many parameters of the kdb+ system that impact performance. For example, you can set if data is stored in memory or on disk. More setting are available in `scripts/q_sys/perfenv`.

## Run multiple benchmarks

You can run multiple test with `scripts/benchmark/run_tsbs.py` wrapper.
E.g.: `python run_tsbs.py -v kdb -g generate_config.yaml -l load_kdb.yaml -q query_config.yaml -u iot -r run_kdb.yaml`
(This is also implemented for timescaledb and questdb)
